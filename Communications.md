# LonWorks
### Вступление
LON расшифровывается как Local Operation Network, а LonWorks был разработан Echelon Corporation в 1988 году как сетевая платформа для поддержки управляющих приложений. Первоначально известный как LonTalk, он был принят ANSI как стандарт ANSI / CEA-709.1-B. Ecehelon также приняла свои системы передачи сигналов по линиям электропередач и витой паре в качестве стандартов ANSI. В Европе LonWorks стал стандартом EN 14908, а в 2008 году на международном уровне были выпущены следующие стандарты:
* ISO/IEC 14908-1 - Communications Protocol
* ISO/IEC 14908-2 - Twisted Pair Signalling Technology
* ISO/IEC 14908-3 - Power Line Signalling Technology
* ISO/IEC 14908-4 - IP Compatibility
LonWorks - это одноранговый протокол, который может работать по витой паре, Ethernet или питающей сети. Инструмент настройки сети, такой как LonMaker, используется для настройки обмена данными путем привязки входа одного устройства к выходу другого устройства. Микросхема Neuron содержащит всю сетевую прошивку, изготовленный разными производителями. В чипе Neuron используется язык программирования Neuron C.

### Формат кадра Control Network Protocol (CNP)

* Bit-sync - настраиваемое количество установленных битов (единиц), которые действуют как преамбула.
* Byte-sync - установлен в 0 и отмечает конец преамбулы. Pri - Приоритет, используемый с прогнозируемым P-Persistent CSMA. Значение 0 используется для неприоритетных кадров, а значение 1 используется для приоритетных кадров.
* Path - Приемопередатчик специального назначения может быть сопряжен с двумя физическими каналами или с двумя физическими битовыми кодировками на одном и том же канале. Значение 0 используется для основного канала, а значение 1 используется для альтернативного канала.
* Delta Backlog - используется для настройки количества слотов для произвольного доступа. Принимающие устройства добавляют это значение к своей оценке невыполненной работы, чтобы учесть передачу этого  кадра.

* Network Layer Datagram
  * Версия - всегда 0.
  * Формат пакета  
   0 - Transport Packet  
   1 - Session Packet  
   2 - Authenticated Packet  
   3 - Presentation Packet  
  * Формат адеса  
   0 - Subnet Broadcast  
   1 - Group  
   2 - Subnet, Node or Group Acknowledgement  
   3 - Neuron ID  
  * Длина  
   0 - 0 bytes  
   1 - 1 byte  
   2 - 3 bytes  
   3 - 6 bytes  
  * Address - 3 to 9 bytes
  * Domain - 0, 1, 3 or 6 bytes
  * Packet
* CRC-16 - CCITT standard CRC (X16 + X12 + X5 + 1). Полином вычисляется для всего пакета и заголовка канального уровня. Период простоя считается любым, превышающим 2 бит, и отмечает конец кадра.

### Control Network Protocol

Протокол LonWorks (ранее LonTalk) следует семиуровневой модели OSI в своей
структуре.

1. Физический уровень. EIA/TIA 485, линии питания и свободные топологии.
2. Канальный уровень. Внесены улучшения в алгоритмах Carrier Sense Multiple
  Access (CSMA) Ethernet (см. ниже). Кроме того, используется двухфазное
  пространственное кодирование (разновидность дифференциального манчестерского
  кодирования, поэтому не имеет значения, в каком направлении будут завершены
  провода связи.
3. Сетевой уровень. Каждому чипу Neuron можно назначить два логических адреса и
  до 15 идентификаторов группы. Адресация является иерархической, начиная с
  8-битного идентификатора домена узла, за которым следует 8-битный
  идентификатор подсети, а затем 8-битный идентификатор узла. Узел может быть
  членом нескольких групп многоадресной рассылки, снова каждого адреса группы
  или идентификатора группы, представленного в виде одного байта. В домене может
  быть до 256 групп многоадресной рассылки и 255 подсетей, каждая из которых
  может иметь 127 узлов. Адрес домена может быть закодирован либо нулевой
  длиной, либо одним байтом, либо тремя байтами, либо шестью байтами для
  обеспечения уникальности. Этот режим адресации обеспечивает простую
  маршрутизацию пакетов по ссылкам. Таблицы маршрутизации имеют массив из 256
  бит, определяющий, может ли сообщение пройти через маршрутизатор в заданную
  подсеть. Члены с одним и тем же идентификатором группы могут находиться где
  угодно в домене и могут пересекать маршрутизаторы.
4. Транспортный уровень. - дублирование и повторная передача сообщений
  обрабатываются на этом уровне. Сообщения могут использовать надежные службы
  (требующие подтверждения или ответа) как для одноадресной, так и для
  многоадресной передачи, или могут использоваться ненадежные службы. Общее
  время транзакции на стороне получателя, количество повторных попыток и время
  между повторными попытками можно настроить.
5. Уровень сессий. Здесь происходит управление запросами и ответами. Ответ на
  сообщение сохраняется временно на тот случай, если потребуется повторная
  попытка, тем самым сохраняя сообщение, которое необходимо воссоздать и
  повторно передать.
6. Уровень представлений. Здесь идентифицируются элементы данных, и создается
  семантика того, как данные передаются на уровень приложения, используемой
  моделью является модель издатель-подписчик (Publisher-Subscriber).
7. Уровень приложений. Сетевые переменные - это особые типы данных, например
  температура в градусах Цельсия, а также верхний и нижний пределы. Если выход
  сетевой переменной на одном устройстве привязан к входу сетевой переменной на
  другом устройстве, то опубликованное изменение будет отправлено каждому
  подписчику с этим значением. Другие функции на уровне приложения:
    Автоматическое обнаружение узлов
    Автоматическое обнаружение сетевых интерфейсов
    Автоматическое обнаружение сетевых переменных
    Автоматическое обнаружение функциональных профилей
    Обновление программного обеспечения узла

### CSMA

CSMA был принят и расширен, чтобы обеспечить более эффективные способы
предоставления доступа станции к среде передачи.

##### P-Persistent CSMA
Обеспечивает доступ к среде через слоты. Если имеется 10 слотов, то вероятность
(P) доступа к среде равна 0,1. Чем больше создано слотов, тем более случайным
является доступ к среде и, следовательно, меньше вероятность конфликта.
В незанятой сети все еще существует средняя задержка доступа к среде, которая
определяется числом слотов / 2.

##### Non-Persistent CSMA
Станция выполняет случайный выбор при доступе к среде, что полезно, когда есть
всплеск активности, и несколько устройств могут реагировать на одно событие.

##### Predictive P-Persistent CSMA
Важному устройству может быть предоставлен приоритетный доступ к каналу связи,
когда сеть перегружена. Некоторым станциям может быть назначено несколько
интервалов случайного выбора только для их использования. Станция с этой
привилегией приоритета MAC может использовать выделенный слот и избегать любой
конкуренции за доступ к каналу.
Когда станция отправляет сообщение, количество ответных пакетов, которые будет
сгенерировано сообщением, помещается в заголовок уровня 2 и известно как Link
Backlog Increment, отправитель должен отслеживать ответы, чтобы знать, когда
прекратить повторную передачу. Узлы на ссылке получают пакеты и просматривают
заголовок уровня 2, чтобы увидеть приращение невыполненной работы связи. Это
отставание используется для настройки количества слотов, которые они
рандомизируют для доступа к собственному каналу, которое увеличивается при
увеличении трафика и уменьшается при его уменьшении.
Протокол LonWorks изменяет количество случайных интервалов на основе
краткосрочного будущего. Было показано, что алгоритм MAC протокола для
одноранговой сети использует полосу пропускания канала до 80 процентов от
максимальной с частотой конфликтов менее 4 процентов, что выгодно отличается
от CSMA / CD Ethernet, где вы можете получить 100% коллизии при 40%
использовании полосы пропускания (что приводит к временному отключению сети).
Таким образом, он эффективен и не требует знания количества станций в канале
связи и оборудования для обнаружения коллизий.

### Сетевые переменные(Network Variables)

Сетевые переменные используются для связи между узлами, и каждый из них имеет
направление, тип и длину. Каждый узел будет иметь свой собственный набор сетевых
переменных, которые создаются как часть прикладной программы внутри этого узла.
Их можно сравнить с «виртуальными проводами», соединяющими устройства. Связи
узлов разрешены только между входами и выходами одного и того же типа, которые
настраиваются в процессе связывания. Выходная переменная может отправлять данные
в несколько входных переменных в сети (многоадресная передача), или несколько
выходных переменных могут отправлять данные в одну входную переменную или даже
между выходами и входами на одном устройстве (поворотное соединение).

Типы входных и выходных переменных определяются в растущем наборе стандартных
типов сетевых переменных (SNVT), называемых Snivets. Типы переменных чаще всего
соответствуют физическим измерениям, таким как температура, влажность, давление,
уровни и т. Д., А также числовому типу, например целочисленному, с плавающей
запятой, двоичному и т. Д. Главный список SNVT можно найти на:
    https://www.lonmark.org/nvs/
Каждая сетевая переменная на устройстве имеет уникальный индекс сетевой
переменной. Индексы сетевых переменных назначаются по порядку, начиная с
индекса 0. Селектор сетевой переменной - это идентификатор, который используется
для сопоставления сообщения обновления сетевой переменной с сетевой переменной в
принимающем приложении. Каждое устройство управляет одной или двумя таблицами,
которые используются для сопоставления селектора сетевой переменной с индексом
сетевой переменной. Первая таблица, реализуемая всеми устройствами, - это
таблица конфигурации сетевых переменных. Вторая таблица, которая может быть
реализована устройством, - это таблица псевдонимов сетевых переменных.
Устройство использует эти таблицы для преобразования индекса сетевой переменной
на передающем устройстве в селектор сетевых переменных.

Селекторы сетевых переменных можно повторно использовать в домене.

Селектор сетевой переменной - это 14-битный идентификатор со значением от 0x0 до
3FFFx0. Значения селектора от 3000x0 до 3FFFx0 зарезервированы для несвязанных
сетевых переменных. Значения селектора от 0x0 до 2FFFx0 доступны для связанных
сетевых переменных.

### Сообщения

Системы сообщений хранятся в сетевом образе (для облегчения дальнейшей модификации), а сами сообщения доставляются несколькими способами:
* UnAcked - Без подтверждения, что означает, что сообщение отправлено без ожидания возврата какого-либо подтверждения.
* UnAckedR - Неподтвержденный повтор, означающий, что сообщение отправляется несколько раз в соответствии с заранее определенным расписанием, чтобы увеличить вероятность его получения устройствами.
* Acked -   Подтвержденная с автоматическими повторными попытками - это механизм по умолчанию, при котором принимающее устройство отправляет обратно подтверждение (Ack). Если Ack не был получен в течение указанного периода времени, сообщение отправляется повторно до трех раз, если система не была запрограммирована иначе, после этого момента устанавливается флаг ошибки доставки сообщения.
* Request/Response - этот механизм опроса используется между приложениями для получения данных.

Хотя шифрование данных не поддерживается, можно реализовать аутентификацию,
чтобы проверить, авторизован ли отправитель для отправки конкретного сообщения.
При установке устройствам выдается 48-битный ключ для каждого домена. При
отправке аутентифицированного сообщения следует следующая последовательность:
1. Аутентифицированное сообщение отправляется от отправителя к получателю.
2. Получатель отправляет отправителю 64-битное случайное число в качестве
  запроса.
3. Отправитель трансформирует задачу с помощью 48-битного ключа.
4. Отправитель отправляет ответ на запрос получателю.
5. Приемник также преобразует задачу, используя 48-битный ключ, и сравнивает
  два результата.
6. В случае успеха получатель отправляет подтверждение отправителю.

Сообщения, которыми обмениваются приложения, состоят из 1-байтового кода
сообщения, за которым следуют до 227 байтов данных, если сообщение не содержит
сетевую переменную, и в этом случае будет от 1 до 31 байта данных. Диапазон
типов сообщений и их кодов следующие:

|                                               |     HEX  |     DEC
|Пользовательское приложение (User Application) |  00 - 2F | 	0 - 47
|Стандартное приложение (Standard Application)	|  30 - 3E | 	48 - 62
|Внешний кадр (Foreign Frame)	                  |  40 - 4E | 	64 - 78
|Диагностика сети (Network Diagnostic)	        |  50 - 5F |	80 - 95
|Сетевое управление (Network Management)	      |  60 - 7F |	96 - 127
|Сетевая переменная (Network Variable)	        |  80 - FF |	128 - 255

Это перевод. Оригинал здесь: http://www.rhyshaden.com/lonworks.htm
